---
# =============================================================================
# fail2ban installation for RHEL-family systems
# =============================================================================
# Supports: Amazon Linux 2023, RHEL 8/9, Rocky Linux, AlmaLinux

- name: Install EPEL repository on Rocky/Alma
  ansible.builtin.dnf:
    name: epel-release
    state: present
  when: ansible_distribution in ['Rocky', 'AlmaLinux']

- name: Install EPEL repository on RHEL
  ansible.builtin.dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
    state: present
    disable_gpg_check: true
  when: ansible_distribution == 'RedHat'

- name: Install fail2ban package
  ansible.builtin.dnf:
    name: fail2ban
    state: present

- name: Ensure iptables is available (for fail2ban backend)
  ansible.builtin.dnf:
    name: iptables
    state: present
  when: fail2ban_use_iptables | bool
