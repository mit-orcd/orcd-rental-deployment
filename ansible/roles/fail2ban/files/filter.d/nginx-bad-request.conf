# Fail2Ban filter to match bad/malformed requests to nginx
# These are typically scanners sending binary garbage or malformed HTTP

[Definition]

# Match various forms of bad requests that result in 400 errors
# - Empty or malformed methods
# - Binary/encoded garbage (TLS handshake to HTTP port, etc.)
failregex = ^<HOST> - \S+ \[\] "[^"]*" 400
            ^<HOST> -.* "\x16\x03.*" 400
            ^<HOST> -.* 400 \d+ "-" "-" "-"$
            ^<HOST> -.* 400 \d+ "-" "-" ".*"$

datepattern = {^LN-BEG}%%ExY(?P<_sep>[-/.])%%m(?P=_sep)%%d[T ]%%H:%%M:%%S(?:[.,]%%f)?(?:\s*%%z)?
              ^[^\[]*\[({DATE})
              {^LN-BEG}

journalmatch = _SYSTEMD_UNIT=nginx.service + _COMM=nginx

