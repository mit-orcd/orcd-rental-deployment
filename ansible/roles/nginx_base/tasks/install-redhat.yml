---
# =============================================================================
# RHEL/Amazon Linux Installation Tasks
# =============================================================================
# Supports: Amazon Linux 2023, RHEL 8/9, Rocky Linux, AlmaLinux

- name: Update package cache
  ansible.builtin.dnf:
    update_cache: true

- name: Install required packages
  ansible.builtin.dnf:
    name:
      - nginx
      - python3
      - python3-pip
      - python3-devel
      - openssl
      # Note: curl-minimal is pre-installed on Amazon Linux 2023 and conflicts with curl
      # The minimal version is sufficient for our needs
    state: present

- name: Enable nginx service
  ansible.builtin.systemd:
    name: nginx
    enabled: true

- name: Install firewalld
  ansible.builtin.dnf:
    name: firewalld
    state: present
  when: configure_firewall | bool

- name: Configure firewalld for HTTP/HTTPS
  when: configure_firewall | bool
  block:
    - name: Start firewalld if not running
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true
      failed_when: false

    - name: Open HTTP port in firewalld
      ansible.posix.firewalld:
        service: http
        permanent: true
        state: enabled
        immediate: true
      failed_when: false

    - name: Open HTTPS port in firewalld
      ansible.posix.firewalld:
        service: https
        permanent: true
        state: enabled
        immediate: true
      failed_when: false

- name: Create certbot virtual environment
  ansible.builtin.pip:
    name: pip
    state: present
    virtualenv: "{{ certbot_venv_path }}"
    virtualenv_command: python3 -m venv

- name: Install certbot in virtual environment
  ansible.builtin.pip:
    name:
      - certbot
      - certbot-nginx
    state: present
    virtualenv: "{{ certbot_venv_path }}"

- name: Create certbot symlink
  ansible.builtin.file:
    src: "{{ certbot_venv_path }}/bin/certbot"
    dest: /usr/bin/certbot
    state: link
    force: true

- name: Verify certbot installation
  ansible.builtin.command: certbot --version
  register: certbot_version
  changed_when: false

- name: Display certbot version
  ansible.builtin.debug:
    msg: "Certbot installed: {{ certbot_version.stdout }}"
