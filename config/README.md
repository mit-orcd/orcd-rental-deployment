# Configuration Directory

This directory contains templates and generated configuration for the ORCD Rental Portal deployment.

## Overview

| File / Dir | Purpose |
|------------|---------|
| `deployment.conf` | Generated or copied from template; used by `install.sh` (plugin version, paths, service user). |
| `deployment.conf.template` | Template for `deployment.conf`. |
| `deploy-config.yaml` | **One-shot deployment**: single config for `scripts/deploy.sh` (domain, OIDC, superuser, etc.). Do not commit (secrets). |
| `deploy-config.yaml.example` | Example for `deploy-config.yaml`; copy and fill in. |
| `coldfront.env.template` | Template for ColdFront env vars (SECRET_KEY, OIDC_*, plugin flags). |
| `local_settings.*.py.template` | Django settings by OIDC provider (globus / generic). |
| `coldfront_auth.py`, `wsgi.py`, `urls.py` | Copied into app dir by install/configure scripts. |
| `plugin_config.yaml.template` | Plugin runtime config (UI, auto-PI, password login). Copied to app dir by `install.sh`. |
| `systemd/`, `nginx/`, `fail2ban/`, `templates/` | Service file, Nginx refs, fail2ban configs, custom templates. |

---

## Deploy config (one-shot deployment)

When using **one-shot deployment** (`scripts/deploy.sh`), all inputs are read from a single file: `deploy-config.yaml` (or path given by `--config`).

### Schema: `deploy-config.yaml`

**Required:**

| Key | Description |
|-----|-------------|
| `domain` | Domain name (SSL, Nginx, OIDC redirect URI). |
| `email` | Email for Let's Encrypt notifications. |
| `oidc.provider` | `globus` or `generic`. |
| `oidc.client_id` | OAuth client ID. |
| `oidc.client_secret` | OAuth client secret. |
| `oidc.authorization_endpoint` | (Generic only.) Authorization URL. |
| `oidc.token_endpoint` | (Generic only.) Token URL. |
| `oidc.userinfo_endpoint` | (Generic only.) UserInfo URL. |
| `oidc.jwks_endpoint` | (Generic only.) JWKS URL. |
| `superuser.username` | ColdFront admin username. |
| `superuser.email` | ColdFront admin email. |
| `superuser.password` | ColdFront admin password (non-interactive `createsuperuser`). |

**Optional (with defaults):**

| Key | Default | Description |
|-----|---------|-------------|
| `plugin_version` | `v0.1` | Plugin git tag or branch. |
| `coldfront_version` | `coldfront[common]` | ColdFront pip spec. |
| `plugin_repo` | `https://github.com/mit-orcd/cf-orcd-rental.git` | Plugin repo URL. |
| `app_dir` | `/srv/coldfront` | Application directory. |
| `venv_dir` | `/srv/coldfront/venv` | Virtualenv directory. |
| `service_user` | `ec2-user` | User that runs ColdFront. |
| `service_group` | `nginx` | Group for Nginx/socket access. |
| `skip_nginx` | `false` | Skip Nginx/SSL step in prereqs. |
| `skip_f2b` | `false` | Skip fail2ban in prereqs. |
| `skip_ssl` | `false` | Skip SSL in nginx base (testing). |

### Example

See `deploy-config.yaml.example`. Copy it to `deploy-config.yaml` and set domain, email, OIDC credentials, and superuser password.

```bash
cp config/deploy-config.yaml.example config/deploy-config.yaml
# Edit config/deploy-config.yaml, then:
sudo ./scripts/deploy.sh --config config/deploy-config.yaml
```

---

## Other config files

- **deployment.conf**: Used by `install.sh`. Can be created manually from `deployment.conf.template` or generated from `deploy-config.yaml` by `scripts/deploy.sh` or `scripts/generate-deployment-conf.sh`.
- **local_settings.py / coldfront.env**: Generated by `scripts/configure-secrets.sh` (interactive or non-interactive with env vars or `--config`).
- **plugin_config.yaml**: Plugin runtime options (created from `plugin_config.yaml.template` by `install.sh`). Reload with `systemctl reload coldfront`.
